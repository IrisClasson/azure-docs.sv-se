---
title: Primär uppdateringstoken (PRT) och Azure AD - Azure Active Directory
description: Vilken roll och hur hanterar vi den primära uppdateringstoken (PRT) i Azure Active Directory?
services: active-directory
ms.service: active-directory
ms.subservice: devices
ms.topic: conceptual
ms.date: 05/29/2019
ms.author: joflore
author: MicrosoftGuyJFlo
manager: daveba
ms.reviewer: ravenn
ms.collection: M365-identity-device-management
ms.openlocfilehash: 9a237ad35d9d5d8abee784926563d972d0ee95f9
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: sv-SE
ms.lasthandoff: 03/28/2020
ms.locfileid: "78672639"
---
# <a name="what-is-a-primary-refresh-token"></a>Vad är en primär uppdateringstoken?

En primär uppdateringstoken (PRT) är en viktig artefakt för Azure AD-autentisering på Windows 10-, iOS- och Android-enheter. Det är en JSON Web Token (JWT) som särskilt utfärdas till Microsofts tokenmäklare för första part för att aktivera enkel inloggning (SSO) över de program som används på dessa enheter. I den här artikeln kommer vi att ge information om hur en PRT utfärdas, används och skyddas på Windows 10-enheter.

Den här artikeln förutsätter att du redan förstår de olika enhetstillstånd som finns i Azure AD och hur enkel inloggning fungerar i Windows 10. Mer information om enheter i Azure AD finns i artikeln [Vad är enhetshantering i Azure Active Directory?](overview.md)

## <a name="key-terminology-and-components"></a>Viktig terminologi och komponenter

Följande Windows-komponenter spelar en nyckelroll när det gäller att begära och använda en PRT:

* **Cloud Authentication Provider** (CloudAP): CloudAP är den moderna autentiseringsleverantören för Windows-inloggning som verifierar användare som loggar in på en Windows 10-enhet. CloudAP tillhandahåller ett plugin-ramverk som identitetsleverantörer kan bygga vidare på för att aktivera autentisering till Windows med hjälp av identitetsleverantörens autentiseringsuppgifter.
* **WEB Account Manager** (WAM): WAM är standardtokenmäklare på Windows 10-enheter. WAM tillhandahåller också ett plugin-ramverk som identitetsleverantörer kan bygga på och aktivera SSO till sina program som förlitar sig på den identitetsleverantören.
* **Azure AD CloudAP plugin:** En Azure AD-specifik plugin som bygger på CloudAP-ramverket, som verifierar användarautentiseringsuppgifter med Azure AD under Windows-inloggning.
* **Azure AD WAM plugin**: En Azure AD-specifik plugin som bygger på WAM-ramverket, som gör det möjligt för SSO till program som är beroende av Azure AD för autentisering.
* **Dsreg**: En Azure AD-specifik komponent på Windows 10, som hanterar enhetsregistreringsprocessen för alla enhetstillstånd.
* **Trusted Platform Module** (TPM): En TPM är en maskinvarukomponent inbyggd i en enhet som tillhandahåller maskinvarubaserade säkerhetsfunktioner för användar- och enhetshemligheter. Mer information finns i artikeln [Trusted Platform Module Technology Overview](/windows/security/information-protection/tpm/trusted-platform-module-overview).

## <a name="what-does-the-prt-contain"></a>Vad innehåller PRT?

En PRT innehåller anspråk som vanligtvis finns i alla Azure AD-uppdateringstoken. Dessutom finns det vissa enhetsspecifika anspråk som ingår i PRT. Det här är skillnaderna:

* **Enhets-ID:** En PRT utfärdas till en användare på en viss enhet. Enhets-ID-anspråket `deviceID` avgör vilken enhet som PRT:n har utfärdats till användaren på. Detta anspråk utfärdas senare till tokens som erhållits via PRT. Enhets-ID-anspråket används för att fastställa auktorisering för villkorlig åtkomst baserat på enhetens tillstånd eller efterlevnad.
* **Sessionsnyckel:** Sessionsnyckeln är en krypterad symmetrisk nyckel som genereras av Azure AD-autentiseringstjänsten, utfärdad som en del av PRT.Session key : The session key is an encrypted symmetric key, generated by the Azure AD authentication service,issued as part of the PRT. Sessionsnyckeln fungerar som bevis på innehav när en PRT används för att hämta token för andra program.

### <a name="can-i-see-whats-in-a-prt"></a>Kan jag se vad som finns i en PRT?

En PRT är en ogenomskinlig blob som skickas från Azure AD vars innehåll inte är känt för några klientkomponenter. Du kan inte se vad som finns inuti en PRT.

## <a name="how-is-a-prt-issued"></a>Hur utfärdas en PRT?

Enhetsregistrering är en förutsättning för enhetsbaserad autentisering i Azure AD. En PRT utfärdas endast till användare på registrerade enheter. Mer detaljerad information om enhetsregistrering finns i artikeln [Windows Hello för företag och enhetsregistrering](/windows/security/identity-protection/hello-for-business/hello-how-it-works-device-registration). Under enhetsregistrering genererar dsreg-komponenten två uppsättningar kryptografiska nyckelpar:

* Enhetsnyckel (dkpub/dkpriv)
* Transportnyckel (tkpub/tkpriv)

De privata nycklarna är bundna till enhetens TPM om enheten har en giltig och fungerande TPM, medan de offentliga nycklarna skickas till Azure AD under enhetsregistreringsprocessen. Dessa nycklar används för att validera enhetens tillstånd under PRT-begäranden.

PRT utfärdas under användarautentisering på en Windows 10-enhet i två scenarier:

* **Azure AD-gick med** eller **Hybrid Azure AD gick med:** En PRT utfärdas under Windows-inloggning när en användare loggar in med sina organisationsautentiseringsuppgifter. En PRT utfärdas med alla autentiseringsuppgifter som stöds av Windows 10, till exempel lösenord och Windows Hello för företag. I det här fallet azure AD CloudAP plugin är den primära myndigheten för PRT.
* **Azure AD-registrerad enhet:** En PRT utfärdas när en användare lägger till ett sekundärt arbetskonto på sin Windows 10-enhet. Användare kan lägga till ett konto i Windows 10 på två olika sätt -  
   * Lägga till ett konto via **använd det här kontot överallt på den här enhetsprompten** efter att ha loggat in på en app (till exempel Outlook)
   * Lägga till ett konto från **Inställningar** > **Konton** > **Access Work eller School** > **Connect**

I Azure AD-registrerade enhetsscenarier är Azure AD WAM-insticksprogrammet den primära behörigheten för PRT eftersom Windows-inloggning inte sker med det här Azure AD-kontot.

> [!NOTE]
> Identitetsleverantörer från tredje part måste stödja WS-Trust-protokollet för att aktivera PRT-utfärdande på Windows 10-enheter. Utan WS-Trust kan PRT inte utfärdas till användare på Hybrid Azure AD-anslutna eller Azure AD-anslutna enheter

## <a name="what-is-the-lifetime-of-a-prt"></a>Vad är livslängden för en PRT?

När en PRT har utfärdats är den giltig i 14 dagar och förnyas kontinuerligt så länge användaren aktivt använder enheten.  

## <a name="how-is-a-prt-used"></a>Hur används en PRT?

En PRT används av två viktiga komponenter i Windows:

* **Azure AD CloudAP plugin:** Under Windows-inloggning, Azure AD CloudAP plugin begär en PRT från Azure AD med hjälp av autentiseringsuppgifter som tillhandahålls av användaren. Den cachelagrar också PRT för att aktivera cachelagrade inloggning när användaren inte har tillgång till en internetanslutning.
* **Azure AD WAM plugin:** När användare försöker komma åt program, Azure AD WAM plugin använder PRT för att aktivera SSO på Windows 10. Azure AD WAM-plugin använder PRT för att begära uppdaterings- och åtkomsttoken för program som är beroende av WAM för tokenbegäranden. Det gör det också möjligt SSO på webbläsare genom att injicera PRT i webbläsaren förfrågningar. Webbläsare SSO i Windows 10 stöds på Microsoft Edge (inbyggt) och Chrome (via Windows 10-konton eller Office Online-tillägg).

## <a name="how-is-a-prt-renewed"></a>Hur förnyas en PRT?

En PRT förnyas i två olika metoder:

* **Azure AD CloudAP plugin var 4 timmar:** CloudAP plugin förnyar PRT var 4 timmar under Windows logga in. Om användaren inte har internetuppkoppling under den tiden kommer CloudAP-insticksprogrammet att förnya PRT när enheten är ansluten till internet.
* **Azure AD WAM plugin under app token förfrågningar:** WAM plugin aktiverar SSO på Windows 10-enheter genom att aktivera tysta token förfrågningar för program. WAM plugin kan förnya PRT under dessa token förfrågningar på två olika sätt:
   * En app begär WAM för en åtkomsttoken tyst men det finns ingen uppdateringstoken tillgänglig för den appen. I det här fallet använder WAM PRT för att begära en token för appen och får tillbaka en ny PRT i svaret.
   * En app begär WAM för en åtkomsttoken men PRT är ogiltig eller Azure AD kräver ytterligare auktorisering (till exempel Azure Multi-Factor Authentication). I det här fallet initierar WAM en interaktiv inloggning som kräver att användaren återuthyrs eller ger ytterligare verifiering och en ny PRT utfärdas vid lyckad autentisering.

### <a name="key-considerations"></a>Viktiga överväganden

* En PRT utfärdas och förnyas endast under autentisering av interna appar. En PRT förnyas eller utfärdas inte under en webbläsarsession.
* I Azure AD-anslutna och hybrid-Azure AD-anslutna enheter är CloudAP-insticksprogrammet den primära behörigheten för en PRT. Om en PRT förnyas under en WAM-baserad tokenbegäran skickas PRT-programmet tillbaka till CloudAP-plugin, vilket verifierar giltigheten för PRT med Azure AD innan den accepteras.

## <a name="how-is-the-prt-protected"></a>Hur skyddas PRT?

En PRT skyddas genom att binda den till den enhet som användaren har loggat in på. Azure AD och Windows 10 aktiverar PRT-skydd med följande metoder:

* **Under första inloggningen**: Under första inloggningen utfärdas en PRT genom att signera begäranden med hjälp av enhetsnyckeln kryptografiskt genererad under enhetsregistrering. På en enhet med en giltig och fungerande TPM skyddas enhetsnyckeln av TPM:en som förhindrar skadlig åtkomst. En PRT utfärdas inte om motsvarande enhetsnyckelsignatur inte kan valideras.
* **Under tokenbegäranden och förnyelse**: När en PRT utfärdas utfärdar Azure AD också en krypterad sessionsnyckel till enheten. Den krypteras med kollektivtrafiknyckeln (tkpub) som genereras och skickas till Azure AD som en del av enhetsregistreringen. Den här sessionsnyckeln kan bara dekrypteras av den privata transportnyckeln (tkpriv) som skyddas av TPM.This session key can only be decrypted by the private transport key (tkpriv) secured by the TPM. Sessionsnyckeln är POP-nyckeln (Proof-of-Possession) för alla begäranden som skickas till Azure AD.  Sessionsnyckeln skyddas också av TPM:en och ingen annan OS-komponent kan komma åt den. Tokenbegäranden eller begäranden om PRT-förnyelse signeras säkert av den här sessionsnyckeln via TPM:en och kan därför inte manipuleras. Azure AD ogiltigförklarar alla begäranden från enheten som inte är signerade av motsvarande sessionsnyckel.

Genom att skydda dessa nycklar med TPM kan illvilliga aktörer inte stjäla tangenterna eller spela upp PRT någon annanstans eftersom TPM är otillgänglig även om en angripare har fysiskt innehav av enheten.  Med hjälp av en TPM ökar därför säkerheten för Azure AD Joined, Hybrid Azure AD-anslutna och Azure AD-registrerade enheter mot stöld av autentiseringsuppgifter. För prestanda och tillförlitlighet är TPM 2.0 den rekommenderade versionen för alla Azure AD-enhetsregistreringsscenarier på Windows 10.

### <a name="how-are-app-tokens-and-browser-cookies-protected"></a>Hur skyddas apptokens och webbläsarcookies?

**Apptokens**: När en app begär token via WAM utfärdar Azure AD en uppdateringstoken och en åtkomsttoken. WAM returnerar dock bara åtkomsttoken till appen och säkrar uppdateringstoken i cacheminnet genom att kryptera den med användarens DPAPI-nyckel (Data Protection Application Programming Interface). WAM använder uppdateringstoken på ett säkert sätt genom att signera begäranden med sessionsnyckeln för att utfärda ytterligare åtkomsttoken. DPAPI-nyckeln skyddas av en Azure AD-baserad symmetrisk nyckel i Azure AD själv. När enheten behöver dekryptera användarprofilen med DPAPI-nyckeln tillhandahåller Azure AD DPAPI-nyckeln krypterad av sessionsnyckeln, som CloudAP-plugin begär TPM att dekryptera. Den här funktionen säkerställer konsekvens när det gäller att skydda uppdateringstoken och undviker program som implementerar sina egna skyddsmekanismer.  

**Webbläsarcookies**: I Windows 10 stöder Azure AD webbläsar-SSO i Internet Explorer och Microsoft Edge internt eller i Google Chrome via tillägget För Windows 10-konton. Säkerheten är byggd inte bara för att skydda cookies utan även de slutpunkter som cookies skickas till. Webbläsarcookies skyddas på samma sätt som en PRT är, genom att använda sessionsnyckeln för att signera och skydda cookies.

När en användare initierar en webbläsarinteraktion anropar webbläsaren (eller tillägget) en inbyggd COM-klientvärd. Den inbyggda klientvärden ser till att sidan kommer från en av de tillåtna domänerna. Webbläsaren kan skicka andra parametrar till den inbyggda klientvärden, inklusive en nonce, men den inbyggda klientvärden garanterar validering av värdnamnet. Den inbyggda klientvärden begär en PRT-cookie från CloudAP plugin, som skapar och signerar den med TPM-skyddad sessionsnyckel. Eftersom PRT-cookien är signerad av sessionsnyckeln kan den inte manipuleras. Den här PRT-cookien ingår i begäranden för Azure AD för att validera den enhet som den kommer från. Om du använder webbläsaren Chrome kan endast tillägget som uttryckligen definierats i den inbyggda klientvärdens manifest anropa det så att godtyckliga tillägg gör dessa begäranden. När Azure AD har validerat PRT-cookien utfärdar den en sessionscookie till webbläsaren. Den här sessionscookien innehåller också samma sessionsnyckel som utfärdas med en PRT. Under efterföljande begäranden valideras sessionsnyckeln som effektivt binder cookien till enheten och förhindrar repriser från någon annanstans.

## <a name="when-does-a-prt-get-an-mfa-claim"></a>När får en PRT en MFA fordran?

En PRT kan få ett MFA-anspråk (Multi Factor Authentication) i specifika scenarier. När en MFA-baserad PRT används för att begära token för program överförs MFA-anspråket till dessa apptoken. Den här funktionen ger användarna en sömlös upplevelse genom att förhindra MFA-utmaning för varje app som kräver det. En PRT kan få ett MFA-anspråk på följande sätt:

* **Logga in med Windows Hello för företag:** Windows Hello för företag ersätter lösenord och använder kryptografiska nycklar för att ge stark tvåfaktorsautentisering. Windows Hello för företag är specifikt för en användare på en enhet och kräver själv MFA för att etablera. När en användare loggar in med Windows Hello for Business får användarens PRT ett MFA-anspråk. Det här scenariot gäller även användare som loggar in med smartkort om smartcard-autentisering ger ett MFA-anspråk från ADFS.
   * Eftersom Windows Hello for Business anses vara multifaktorautentisering uppdateras MFA-anspråket när själva PRT:n uppdateras, så MFA-varaktigheten utökas kontinuerligt när användare loggar in med WIndows Hello for Business
* **MFA under WAM interaktiv inloggning:** Under en tokenbegäran via WAM, om en användare är skyldig att göra MFA för att komma åt appen, är PRT som förnyas under den här interaktionen präglas med ett MFA-anspråk.
   * I det här fallet uppdateras inte MFA-anspråket kontinuerligt, så MFA-varaktigheten baseras på den livstid som angetts på katalogen.
   * När en tidigare befintlig PRT och RT används för åtkomst till en app, kommer PRT och RT att betraktas som det första beviset på autentisering. En ny AT kommer att krävas med ett andra bevis och en inpräntad MFA fordran. Detta kommer också att utfärda en ny PRT och RT.
* **MFA under enhetsregistrering**: Om en administratör har konfigurerat sina enhetsinställningar i Azure AD för att [kräva att MFA registrerar enheter](device-management-azure-portal.md#configure-device-settings)måste användaren göra MFA för att slutföra registreringen. Under denna process har den prt som utfärdas till användaren MFA-anspråk som erhållits under registreringen. Den här funktionen gäller endast för användaren som gjorde kopplingsåtgärden, inte för andra användare som loggar in på den enheten.
   * I likhet med WAM interaktiva inloggning, MFA anspråk inte uppdateras kontinuerligt, så MFA varaktigheten baseras på den livstid som anges på katalogen.

Windows 10 har en partitionerad lista över PRT:er för varje autentiseringsuppgifter. Så, det finns en PRT för varje Windows Hello för företag, lösenord eller smartcard. Den här partitioneringen säkerställer att MFA-anspråk isoleras baserat på den autentiseringsuppgifter som används och inte blandas ihop under tokenbegäranden.

## <a name="how-is-a-prt-invalidated"></a>Hur är en PRT ogiltigförklaras?

En PRT är ogiltig i följande scenarier:

* **Ogiltig användare**: Om en användare tas bort eller inaktiveras i Azure AD är deras PRT ogiltigt och kan inte användas för att hämta token för program. Om en borttagen eller inaktiverad användare redan har loggat in på en enhet tidigare loggas den in dem tills CloudAP är medvetet om deras ogiltiga tillstånd. När CloudAP har fastställt att användaren är ogiltig blockerar den efterföljande inloggningar. En ogiltig användare blockeras automatiskt från inloggning till nya enheter som inte har sina autentiseringsuppgifter cachelagrade.
* **Ogiltig enhet**: Om en enhet tas bort eller inaktiveras i Azure AD är den prt som erhålls på den enheten ogiltig och kan inte användas för att hämta token för andra program. Om en användare redan är inloggad på en ogiltig enhet kan han eller hon fortsätta att göra det. Men alla token på enheten är ogiltiga och användaren har inte SSO till några resurser från den enheten.
* **Lösenordsändring**: När en användare har ändrat sitt lösenord ogiltigförklaras den PRT som erhållits med det tidigare lösenordet av Azure AD. Lösenordsändring resulterar i att användaren får en ny PRT. Denna ogiltigförklaring kan ske på två olika sätt:
   * Om användaren loggar in i Windows med sitt nya lösenord, ignorerar CloudAP den gamla PRT och begär Azure AD att utfärda en ny PRT med sitt nya lösenord. Om användaren inte har någon internetanslutning kan det nya lösenordet inte valideras, kan Windows kräva att användaren anger sitt gamla lösenord.
   * Om en användare har loggat in med sitt gamla lösenord eller ändrat sitt lösenord efter inloggning i Windows, används den gamla PRT för alla WAM-baserade tokenbegäranden. I det här fallet uppmanas användaren att omauktorisera under WAM-tokenbegäran och en ny PRT utfärdas.
* **TPM-problem:** Ibland kan en enhets TPM vackla eller misslyckas, vilket leder till otillgänglighet för nycklar som skyddas av TPM. I det här fallet är enheten oförmögen att få en PRT eller begära token med hjälp av en befintlig PRT eftersom den inte kan bevisa innehav av kryptografiska nycklar. Därför ogiltigförklaras alla befintliga prt av Azure AD. När Windows 10 upptäcker ett fel initierar det ett återställningsflöde för att registrera om enheten med nya kryptografiska nycklar. Med Hybrid Azure Ad-koppling, precis som den första registreringen, sker återställningen tyst utan användarindata. För Azure AD-anslutna eller Azure AD-registrerade enheter måste återställningen utföras av en användare som har administratörsbehörighet på enheten. I det här fallet initieras återställningsflödet av en Windows-prompt som hjälper användaren att återställa enheten.

## <a name="detailed-flows"></a>Detaljerade flöden

Följande diagram illustrerar den underliggande informationen vid utfärdande, förnyelse och användning av en PRT för att begära en åtkomsttoken för ett program. Dessutom beskriver dessa steg också hur de ovan nämnda säkerhetsmekanismerna tillämpas under dessa interaktioner.

### <a name="prt-issuance-during-first-sign-in"></a>PRT-emission under första inloggningen

![PRT-emission under första tecknet i detaljerat flöde](./media/concept-primary-refresh-token/prt-initial-sign-in.png)

> [!NOTE]
> I Azure AD-anslutna enheter sker det här utbytet synkront för att utfärda en PRT innan användaren kan logga in på Windows. I hybrid Azure AD-anslutna enheter är lokal Active Directory den primära behörigheten. Så är användaren bara väntar tills de kan förvärva en TGT att logga in, medan PRT utfärdande händer asynkront. Det här scenariot gäller inte för Azure AD-registrerade enheter eftersom inloggning inte använder Azure AD-autentiseringsuppgifter.

| Steg | Beskrivning |
| :---: | --- |
| A | Användaren anger sitt lösenord i inloggningsgränssnittet. Inloggningsgränssnittet skickar autentiseringsuppgifterna i en auth-buffert till LSA, som i sin tur skickar den internt till CloudAP. CloudAP vidarebefordrar den här begäran till CloudAP-insticksprogrammet. |
| B | CloudAP-plugin initierar en begäran om sfäridentifiering för att identifiera identitetsprovidern för användaren. Om användarens klient har en federationsprovider setup returnerar Azure AD federationsleverantörens Metadata Exchange-slutpunkt (MEX) slutpunkt. Om inte returnerar Azure AD att användaren hanteras och anger att användaren kan autentisera med Azure AD. |
| C | Om användaren hanteras får CloudAP nonce från Azure AD. Om användaren är federerad begär CloudAP-plugin en SAML-token från federationsleverantören med användarens autentiseringsuppgifter. När den tar emot, SAML-token, begär den en nonce från Azure AD. |
| D | CloudAP-plugin konstruerar autentiseringsbegäran med användarens autentiseringsuppgifter, nonce och ett mäklaromfattsområde, signerar begäran med enhetsnyckeln (dkpriv) och skickar den till Azure AD. I en federerad miljö använder CloudAP-plugin SAML-token som returneras av federationsleverantören i stället för användarens autentiseringsuppgifter. |
| E | Azure AD validerar användarautentiseringsuppgifterna, nonce- och enhetssignaturen, verifierar att enheten är giltig i klienten och utfärdar den krypterade PRT.Azure AD validates the user credentials, the nonce, and device signature, verifierar att enheten är giltig i klienten och utfärdar den krypterade PRT.Azure AD validates the user credentials, the nonce, and device signature, verifierar att enheten är giltig i klienten och utfärdar den krypterade PRT.Azure Tillsammans med PRT utfärdar Azure AD också en symmetrisk nyckel, kallad sessionsnyckeln krypterad av Azure AD med hjälp av transportnyckeln (tkpub). Dessutom är sessionsnyckeln också inbäddad i PRT. Den här sessionsnyckeln fungerar som PoP-nyckel (Proof-of-possession) för efterföljande begäranden med PRT. |
| F | CloudAP plugin skickar krypterad PRT och session nyckel till CloudAP. CloudAP begär att TPM:en dekrypterar sessionsnyckeln med hjälp av transportnyckeln (tkpriv) och krypterar om den med TPM:s egen nyckel. CloudAP lagrar den krypterade sessionsnyckeln i cacheminnet tillsammans med PRT. |

### <a name="prt-renewal-in-subsequent-logons"></a>PRT förnyelse i efterföljande inloggningar

![PRT förnyelse i efterföljande inloggningar](./media/concept-primary-refresh-token/prt-renewal-subsequent-logons.png)

| Steg | Beskrivning |
| :---: | --- |
| A | Användaren anger sitt lösenord i inloggningsgränssnittet. Inloggningsgränssnittet skickar autentiseringsuppgifterna i en auth-buffert till LSA, som i sin tur skickar den internt till CloudAP. CloudAP vidarebefordrar den här begäran till CloudAP-insticksprogrammet. |
| B | Om användaren tidigare har loggat in på användaren initieras cachelagrade inloggning och autentiseringsuppgifter för att logga in användaren. Var fjärde timme initierar CloudAP-insticksprogrammet PRT-förnyelse asynkront. |
| C | CloudAP-plugin initierar en begäran om sfäridentifiering för att identifiera identitetsprovidern för användaren. Om användarens klient har en federationsprovider setup returnerar Azure AD federationsleverantörens Metadata Exchange-slutpunkt (MEX) slutpunkt. Om inte returnerar Azure AD att användaren hanteras och anger att användaren kan autentisera med Azure AD. |
| D | Om användaren är federerad begär CloudAP-plugin en SAML-token från federationsleverantören med användarens autentiseringsuppgifter. När den tar emot, SAML-token, begär den en nonce från Azure AD. Om användaren hanteras får CloudAP direkt nonce från Azure AD. |
| E | CloudAP-plugin konstruerar autentiseringsbegäran med användarens autentiseringsuppgifter, nonce och den befintliga PRT, signerar begäran med sessionsnyckeln och skickar den till Azure AD. I en federerad miljö använder CloudAP-plugin SAML-token som returneras av federationsleverantören i stället för användarens autentiseringsuppgifter. |
| F | Azure AD validerar signaturen sessionsnyckel genom att jämföra den med sessionsnyckeln som är inbäddad i PRT, validerar nonce och verifierar att enheten är giltig i klienten och utfärdar en ny PRT. Som tidigare sett åtföljs PRT igen med sessionsnyckeln krypterad med transportnyckel (tkpub). |
| G | CloudAP plugin skickar krypterad PRT och session nyckel till CloudAP. CloudAP begär att TPM:en dekrypterar sessionsnyckeln med hjälp av transportnyckeln (tkpriv) och krypterar om den med TPM:s egen nyckel. CloudAP lagrar den krypterade sessionsnyckeln i cacheminnet tillsammans med PRT. |

### <a name="prt-usage-during-app-token-requests"></a>PRT-användning under apptokenbegäranden

![PRT-användning under apptokenbegäranden](./media/concept-primary-refresh-token/prt-usage-app-token-requests.png)

| Steg | Beskrivning |
| :---: | --- |
| A | Ett program (till exempel Outlook, OneNote osv.) initierar en tokenbegäran till WAM. WAM, i sin tur, ber Azure AD WAM plugin för att betjäna token begäran. |
| B | Om en uppdateringstoken för programmet redan är tillgänglig använder Azure AD WAM-insticksprogrammet den för att begära en åtkomsttoken. För att bevisa enhetsbindning signerar WAM-insticksprogrammet begäran med sessionsnyckeln. Azure AD validerar sessionsnyckeln och utfärdar en åtkomsttoken och en ny uppdateringstoken för appen, krypterad av sessionsnyckeln. WAM plugin begär Cloud AP plugin för att dekryptera tokens, som i sin tur begär TPM att dekryptera med sessionsnyckeln, vilket resulterar i WAM plugin få båda tokens. Därefter ger WAM plugin endast åtkomsttoken till programmet, medan det krypterar uppdateringstoken med DPAPI och lagrar den i sin egen cache  |
| C |  Om en uppdateringstoken för programmet inte är tillgänglig använder Azure AD WAM-insticksprogrammet PRT för att begära en åtkomsttoken. För att bevisa innehav, WAM plugin undertecknar begäran som innehåller PRT med Sessionsnyckeln. Azure AD validerar signaturen sessionsnyckel genom att jämföra den med sessionsnyckeln som är inbäddad i PRT, verifierar att enheten är giltig och utfärdar en åtkomsttoken och en uppdateringstoken för programmet. Dessutom kan Azure AD utfärda en ny PRT (baserat på uppdateringscykel), alla krypterade av sessionsnyckeln. |
| D | WAM plugin begär Cloud AP plugin för att dekryptera tokens, som i sin tur begär TPM att dekryptera med sessionsnyckeln, vilket resulterar i WAM plugin få båda tokens. Därefter ger WAM plugin endast åtkomsttoken till programmet, medan det krypterar uppdateringstoken med DPAPI och lagrar den i sin egen cache. WAM plugin kommer att använda uppdatera token framöver för detta program. WAM plugin ger också tillbaka den nya PRT till Cloud AP plugin, som validerar PRT med Azure AD innan du uppdaterar den i sin egen cache. Cloud AP plugin kommer att använda den nya PRT framöver. |
| E | WAM tillhandahåller den nyligen utfärdade åtkomsttoken till WAM, vilket i sin tur ger den tillbaka till det anropande programmet|

### <a name="browser-sso-using-prt"></a>Webbläsare SSO med PRT

![Webbläsare SSO med PRT](./media/concept-primary-refresh-token/browser-sso-using-prt.png)

| Steg | Beskrivning |
| :---: | --- |
| A | Användaren loggar in i Windows med sina autentiseringsuppgifter för att få en PRT. När användaren öppnar webbläsaren, webbläsaren (eller tillägget) läser in webbadresserna från registret. |
| B | När en användare öppnar en Azure AD-inloggnings-URL validerar webbläsaren eller tillägget URL:en med de som hämtas från registret. Om de matchar anropar webbläsaren den inbyggda klientvärden för att hämta en token. |
| C | Den inbyggda klientvärden verifierar att webbadresserna tillhör Microsofts identitetsleverantörer (Microsoft-konto eller Azure AD), extraherar en nonce som skickas från webbadressen och ringer ett samtal till CloudAP-insticksprogrammet för att få en PRT-cookie. |
| D | CloudAP-insticksprogrammet skapar PRT-cookien, loggar in med den TPM-bundna sessionsnyckeln och skickar tillbaka den till den inbyggda klientvärden. Eftersom cookien signeras av sessionsnyckeln kan den inte manipuleras. |
| E | Den inbyggda klientvärden returnerar den här PRT-cookien till webbläsaren, som inkluderar den som en del av begäranden x-ms-RefreshTokenCredential och begärandetokens från Azure AD. |
| F | Azure AD validerar signaturen Sessionsnyckel på PRT-cookien, validerar nonce, verifierar att enheten är giltig i klienten och utfärdar en ID-token för webbsidan och en krypterad sessionscookie för webbläsaren. |

## <a name="next-steps"></a>Nästa steg

Mer information om felsökning av PRT-relaterade problem finns i artikeln [Felsökning av hybrid-Azure Active Directory-anslutna enheter till Windows 10 och Windows Server 2016](troubleshoot-hybrid-join-windows-current.md).
