---
title: Konfigurera daemonappar som anropar webb-API:er – Microsoft identity platform | Azure
description: Lär dig hur du konfigurerar koden för ditt daemonprogram som anropar webb-API:er (appkonfiguration)
services: active-directory
documentationcenter: dev-center-name
author: jmprieur
manager: CelesteDG
editor: ''
ms.service: active-directory
ms.subservice: develop
ms.devlang: na
ms.topic: conceptual
ms.tgt_pltfrm: na
ms.workload: identity
ms.date: 10/30/2019
ms.author: jmprieur
ms.custom: aaddev
ms.openlocfilehash: fc441ef64f98ace04b7b847c03d575215656f9db
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: sv-SE
ms.lasthandoff: 03/28/2020
ms.locfileid: "77611831"
---
# <a name="daemon-app-that-calls-web-apis---code-configuration"></a>Daemon app som anropar webb-API: er - kodkonfiguration

Lär dig hur du konfigurerar koden för ditt demonprogram som anropar webb-API:er.

## <a name="msal-libraries-that-support-daemon-apps"></a>MSAL-bibliotek som stöder daemonappar

Dessa Microsoft-bibliotek stöder daemonappar:

  MSAL-bibliotek | Beskrivning
  ------------ | ----------
  ![MSAL.NET](media/sample-v2-code/logo_NET.png) <br/> MSAL.NET  | Plattformarna .NET Framework och .NET Core stöds för att skapa daemon-program. (UWP, Xamarin.iOS och Xamarin.Android stöds inte eftersom dessa plattformar används för att skapa offentliga klientprogram.)
  ![Python](media/sample-v2-code/logo_python.png) <br/> MSAL Python | Stöd för daemonprogram i Python.
  ![Java](media/sample-v2-code/logo_java.png) <br/> MSAL Java | Stöd för demonprogram i Java.

## <a name="configure-the-authority"></a>Konfigurera behörigheten

Daemon-program använder programbehörigheter i stället för delegerade behörigheter. Så deras kontotyp som stöds kan inte vara ett konto i någon organisationskatalog eller något personligt Microsoft-konto (till exempel Skype, Xbox, Outlook.com). Det finns ingen klientadministratör som ger samtycke till en demonansökan för ett personligt Microsoft-konto. Du måste välja *konton i min organisation* eller *konton i någon organisation*.

Så den myndighet som anges i programkonfigurationen ska vara klient (ange ett klient-ID eller ett domännamn som är associerat med din organisation).

Om du är en ISV och vill tillhandahålla ett verktyg `organizations`med flera skiktning kan du använda . Men tänk på att du också måste förklara för dina kunder hur du beviljar administratörsmedgivande. Mer information finns i [Begära samtycke för en hel klient.](v2-permissions-and-consent.md#requesting-consent-for-an-entire-tenant) Det finns också för närvarande en `organizations` begränsning i MSAL: tillåts endast när klientautentiseringsuppgifterna är en programhemlighet (inte ett certifikat).

## <a name="configure-and-instantiate-the-application"></a>Konfigurera och instansiera programmet

I MSAL-bibliotek skickas klientautentiseringsuppgifterna (hemliga eller certifikat) som en parameter för den konfidentiella klientprogramkonstruktionen.

> [!IMPORTANT]
> Även om ditt program är ett konsolprogram som körs som en tjänst, om det är ett demonprogram, måste det vara ett konfidentiellt klientprogram.

### <a name="configuration-file"></a>Konfigurationsfil

Konfigurationsfilen definierar:

- Myndigheten eller molninstansen och klient-ID.
- Klient-ID som du fick från programregistreringen.
- Antingen en klienthemlighet eller ett certifikat.

# <a name="net"></a>[.NET](#tab/dotnet)

[appsettings.json](https://github.com/Azure-Samples/active-directory-dotnetcore-daemon-v2/blob/master/1-Call-MSGraph/daemon-console/appsettings.json) från [exemplet med .NET Core-konsoldemon.](https://github.com/Azure-Samples/active-directory-dotnetcore-daemon-v2)

```JSon
{
  "Instance": "https://login.microsoftonline.com/{0}",
  "Tenant": "[Enter here the tenantID or domain name for your Azure AD tenant]",
  "ClientId": "[Enter here the ClientId for your application]",
  "ClientSecret": "[Enter here a client secret for your application]",
  "CertificateName": "[Or instead of client secret: Enter here the name of a certificate (from the user cert store) as registered with your application]"
}
```

Du anger `ClientSecret` antingen `CertificateName`a eller a . Dessa inställningar är exklusiva.

# <a name="python"></a>[Python](#tab/python)

När du skapar en konfidentiell klient med klienthemligheter är [filen parameters.json](https://github.com/Azure-Samples/ms-identity-python-daemon/blob/master/1-Call-MsGraph-WithSecret/parameters.json) config i [pythondemon-exemplet](https://github.com/Azure-Samples/ms-identity-python-daemon) följande:

```Json
{
  "authority": "https://login.microsoftonline.com/Enter_the_Tenant_Name_Here",
  "client_id": "your_client_id",
  "scope": [ "https://graph.microsoft.com/.default" ],
  "secret": "The secret generated by AAD during your confidential app registration",
  "endpoint": "https://graph.microsoft.com/v1.0/users"
}
```

När du skapar en konfidentiell klient med certifikat är [filen parameters.json](https://github.com/Azure-Samples/ms-identity-python-daemon/blob/master/2-Call-MsGraph-WithCertificate/parameters.json) config i [python daemon-exemplet](https://github.com/Azure-Samples/ms-identity-python-daemon) följande:

```Json
{
  "authority": "https://login.microsoftonline.com/Enter_the_Tenant_Name_Here",
  "client_id": "your_client_id",
  "scope": [ "https://graph.microsoft.com/.default" ],
  "thumbprint": "790E... The thumbprint generated by AAD when you upload your public cert",
  "private_key_file": "server.pem",
  "endpoint": "https://graph.microsoft.com/v1.0/users"
}
```

# <a name="java"></a>[Java](#tab/java)

```Java
 private final static String CLIENT_ID = "";
 private final static String AUTHORITY = "https://login.microsoftonline.com/<tenant>/";
 private final static String CLIENT_SECRET = "";
 private final static Set<String> SCOPE = Collections.singleton("https://graph.microsoft.com/.default");
```

---

### <a name="instantiate-the-msal-application"></a>Instansiera MSAL-programmet

Om du vill instansiera MSAL-programmet måste du lägga till, referera till eller importera MSAL-paketet (beroende på språk).

Konstruktionen är olika beroende på om du använder klienthemligheter eller certifikat (eller, som ett avancerat scenario, signerade påståenden).

#### <a name="reference-the-package"></a>Referera till paketet

Referera till MSAL-paketet i programkoden.

# <a name="net"></a>[.NET](#tab/dotnet)

Lägg till [Paketet Microsoft.IdentityClient](https://www.nuget.org/packages/Microsoft.Identity.Client) NuGet i programmet.
I MSAL.NET representeras det konfidentiella klientprogrammet `IConfidentialClientApplication` av gränssnittet.
Använd MSAL.NET namnområdet i källkoden.

```csharp
using Microsoft.Identity.Client;
IConfidentialClientApplication app;
```

# <a name="python"></a>[Python](#tab/python)

```python
import msal
```

# <a name="java"></a>[Java](#tab/java)

```java
import com.microsoft.aad.msal4j.ClientCredentialFactory;
import com.microsoft.aad.msal4j.ClientCredentialParameters;
import com.microsoft.aad.msal4j.ConfidentialClientApplication;
import com.microsoft.aad.msal4j.IAuthenticationResult;
import com.microsoft.aad.msal4j.IClientCredential;
import com.microsoft.aad.msal4j.MsalException;
import com.microsoft.aad.msal4j.SilentParameters;
```

---

#### <a name="instantiate-the-confidential-client-application-with-a-client-secret"></a>Instansiera det konfidentiella klientprogrammet med en klienthemlighet

Här är koden för att instansiera det konfidentiella klientprogrammet med en klienthemlighet:

# <a name="net"></a>[.NET](#tab/dotnet)

```csharp
app = ConfidentialClientApplicationBuilder.Create(config.ClientId)
           .WithClientSecret(config.ClientSecret)
           .WithAuthority(new Uri(config.Authority))
           .Build();
```

# <a name="python"></a>[Python](#tab/python)

```Python
config = json.load(open(sys.argv[1]))

# Create a preferably long-lived app instance that maintains a token cache.
app = msal.ConfidentialClientApplication(
    config["client_id"], authority=config["authority"],
    client_credential=config["secret"],
    # token_cache=...  # Default cache is in memory only.
                       # You can learn how to use SerializableTokenCache from
                       # https://msal-python.rtfd.io/en/latest/#msal.SerializableTokenCache
    )
```

# <a name="java"></a>[Java](#tab/java)

```Java
IClientCredential credential = ClientCredentialFactory.createFromSecret(CLIENT_SECRET);

ConfidentialClientApplication cca =
        ConfidentialClientApplication
                .builder(CLIENT_ID, credential)
                .authority(AUTHORITY)
                .build();
```

---

#### <a name="instantiate-the-confidential-client-application-with-a-client-certificate"></a>Instansiera det konfidentiella klientprogrammet med ett klientcertifikat

Här är koden för att skapa ett program med ett certifikat:

# <a name="net"></a>[.NET](#tab/dotnet)

```csharp
X509Certificate2 certificate = ReadCertificate(config.CertificateName);
app = ConfidentialClientApplicationBuilder.Create(config.ClientId)
    .WithCertificate(certificate)
    .WithAuthority(new Uri(config.Authority))
    .Build();
```

# <a name="python"></a>[Python](#tab/python)

```Python
config = json.load(open(sys.argv[1]))

# Create a preferably long-lived app instance that maintains a token cache.
app = msal.ConfidentialClientApplication(
    config["client_id"], authority=config["authority"],
    client_credential={"thumbprint": config["thumbprint"], "private_key": open(config['private_key_file']).read()},
    # token_cache=...  # Default cache is in memory only.
                       # You can learn how to use SerializableTokenCache from
                       # https://msal-python.rtfd.io/en/latest/#msal.SerializableTokenCache
    )
```

# <a name="java"></a>[Java](#tab/java)

I MSAL Java finns det två byggare som instansierar det konfidentiella klientprogrammet med certifikat:

```Java

InputStream pkcs12Certificate = ... ; /* Containing PCKS12-formatted certificate*/
string certificatePassword = ... ;    /* Contains the password to access the certificate */

IClientCredential credential = ClientCredentialFactory.createFromCertificate(pkcs12Certificate, certificatePassword);

ConfidentialClientApplication cca =
        ConfidentialClientApplication
                .builder(CLIENT_ID, credential)
                .authority(AUTHORITY)
                .build();
```

eller

```Java
PrivateKey key = getPrivateKey(); /* RSA private key to sign the assertion */
X509Certificate publicCertificate = getPublicCertificate(); /* x509 public certificate used as a thumbprint */

IClientCredential credential = ClientCredentialFactory.createFromCertificate(key, publicCertificate);

ConfidentialClientApplication cca =
        ConfidentialClientApplication
                .builder(CLIENT_ID, credential)
                .authority(AUTHORITY)
                .build();
```

---

#### <a name="advanced-scenario-instantiate-the-confidential-client-application-with-client-assertions"></a>Avancerat scenario: Instansiera det konfidentiella klientprogrammet med klientpåståenden

# <a name="net"></a>[.NET](#tab/dotnet)

I stället för en klienthemlighet eller ett certifikat kan det konfidentiella klientprogrammet också bevisa sin identitet med hjälp av klientpåståenden.

MSAL.NET har två metoder för att tillhandahålla signerade påståenden till den konfidentiella klientappen:

- `.WithClientAssertion()`
- `.WithClientClaims()`

När du `WithClientAssertion`använder måste du ange en signerad JWT. Det här avancerade scenariot beskrivs i [klientpåståenden](msal-net-client-assertions.md).

```csharp
string signedClientAssertion = ComputeAssertion();
app = ConfidentialClientApplicationBuilder.Create(config.ClientId)
                                          .WithClientAssertion(signedClientAssertion)
                                          .Build();
```

När du `WithClientClaims`använder MSAL.NET kommer att producera ett signerat påstående som innehåller de anspråk som förväntas av Azure AD, plus ytterligare klientanspråk som du vill skicka.
Den här koden visar hur du gör det:

```csharp
string ipAddress = "192.168.1.2";
var claims = new Dictionary<string, string> { { "client_ip", ipAddress } };
X509Certificate2 certificate = ReadCertificate(config.CertificateName);
app = ConfidentialClientApplicationBuilder.Create(config.ClientId)
                                          .WithAuthority(new Uri(config.Authority))
                                          .WithClientClaims(certificate, claims)
                                          .Build();```
```

Återigen, för mer information, se [Klient påståenden](msal-net-client-assertions.md).

# <a name="python"></a>[Python](#tab/python)

I MSAL Python kan du ange klientanspråk med hjälp `ConfidentialClientApplication`av anspråk som kommer att signeras av den här privata nyckeln.

```Python
config = json.load(open(sys.argv[1]))

# Create a preferably long-lived app instance that maintains a token cache.
app = msal.ConfidentialClientApplication(
    config["client_id"], authority=config["authority"],
    client_credential={"thumbprint": config["thumbprint"], "private_key": open(config['private_key_file']).read()},
    client_claims = {"client_ip": "x.x.x.x"}
    # token_cache=...  # Default cache is in memory only.
                       # You can learn how to use SerializableTokenCache from
                       # https://msal-python.rtfd.io/en/latest/#msal.SerializableTokenCache
    )
```

Mer information finns i REFERENSDOKUMENTATIONEN FÖR MSAL Python för [ConfidentialClientApplication](https://msal-python.readthedocs.io/en/latest/#msal.ClientApplication.__init__).

# <a name="java"></a>[Java](#tab/java)

```Java
IClientCredential credential = ClientCredentialFactory.createFromClientAssertion(assertion);

ConfidentialClientApplication cca =
        ConfidentialClientApplication
                .builder(CLIENT_ID, credential)
                .authority(AUTHORITY)
                .build();
```

---

## <a name="next-steps"></a>Nästa steg

# <a name="net"></a>[.NET](#tab/dotnet)

> [!div class="nextstepaction"]
> [Appen Daemon – skaffa token för appen](https://docs.microsoft.com/azure/active-directory/develop/scenario-daemon-acquire-token?tabs=dotnet)

# <a name="python"></a>[Python](#tab/python)

> [!div class="nextstepaction"]
> [Appen Daemon – skaffa token för appen](https://docs.microsoft.com/azure/active-directory/develop/scenario-daemon-acquire-token?tabs=python)

# <a name="java"></a>[Java](#tab/java)

> [!div class="nextstepaction"]
> [Appen Daemon – skaffa token för appen](https://docs.microsoft.com/azure/active-directory/develop/scenario-daemon-acquire-token?tabs=java)

---
